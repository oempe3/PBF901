<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Análise de Consumo e Nível do Tanque PBF901</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <!-- Plotly + PapaParse em um só link -->
  <script src="https://cdn.jsdelivr.net/combine/npm/plotly.js-dist-min@2.24.1/plotly.min.js,npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary-blue: #0B3D91;
      --primary-green: #137547;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
    }
    h1, h2, h3 {
      color: var(--primary-blue);
    }
    section {
      margin-bottom: 40px;
    }
    #chart-consumo,
    #chart-nivel {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 10px;
      height: 400px;
    }
    #analise {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
    }
    ul {
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Análise de Consumo e Nível do Tanque PBF901</h1>

    <section id="consumo">
      <h2>Gráfico de Consumo Diário</h2>
      <div id="chart-consumo"></div>
      <div id="analise"></div>
    </section>

    <section id="nivel">
      <h2>Gráfico de Nível do Tanque</h2>
      <div id="chart-nivel"></div>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const csvFile = 'Verificação consumo e nível do tanque PBF901_CSV.csv';

      fetch(csvFile)
        .then(r => r.text())
        .then(text => {
          const fixed = text.replace(/(\d),(\d)/g,'$1.$2');
          const rows = Papa.parse(fixed, { delimiter: ';', skipEmptyLines: true }).data;
          const raw = rows.slice(1);

          const data = raw.map(row => {
            const [ds, sond, estoque, estoqueAnt, consumo, volRec, flag] = row;
            const [d, m, y] = ds.split('/');
            return {
              date: new Date(+y, m - 1, +d),
              consumo: parseFloat(consumo) || 0,
              estoque: parseFloat(estoque) || 0,
              volRec: parseFloat(volRec) || 0,
              flag: (flag && flag.trim() === 'Recebimento')
            };
          });

          // 1 & 2 – Médias
          const all = data.map(d => d.consumo);
          const avgAll = (all.reduce((a,b)=>a+b,0) / all.length).toFixed(2);
          const cutoff = new Date(2025,5,30);
          const upTo = data.filter(d=> d.date <= cutoff).map(d=> d.consumo);
          const avgUntil = (upTo.reduce((a,b)=>a+b,0) / upTo.length).toFixed(2);

          // 3 – Média semanal (segunda–domingo)
          const weeks = {};
          data.forEach(d => {
            const day = d.date.getDay();
            const monday = new Date(d.date);
            const diff = (day + 6) % 7;
            monday.setDate(monday.getDate() - diff);
            const key = monday.toISOString().slice(0,10);
            (weeks[key] = weeks[key]||[]).push(d.consumo);
          });
          const weekly = Object.entries(weeks).map(([monday, vals]) => {
            const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
            const start = new Date(monday);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            const fmt = d => `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
            return { period: `${fmt(start)} – ${fmt(end)}`, avg };
          });

          // 4 – Média a cada 15 dias
          const halves = {};
          data.forEach(d => {
            const y = d.date.getFullYear();
            const m = (d.date.getMonth()+1).toString().padStart(2,'0');
            const half = d.date.getDate() <= 15 ? '1-15' : '16-end';
            const key = `${y}-${m}-${half}`;
            (halves[key] = halves[key]||[]).push(d.consumo);
          });
          const half15 = Object.entries(halves).map(([key,vals])=>{
            const [y,m,half] = key.split('-');
            const start = half==='1-15' ? `01/${m}/${y}` : `16/${m}/${y}`;
            const endDay = half==='1-15' ? 15 : new Date(+y, +m, 0).getDate();
            const end = `${endDay.toString().padStart(2,'0')}/${m}/${y}`;
            const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
            return { period: `${start} – ${end}`, avg };
          });

          // 5 – Datas de recebimento
          const receipts = data
            .filter(d=>d.flag)
            .map(d => {
              const dt = d.date;
              const str = `${dt.getDate().toString().padStart(2,'0')}/${(dt.getMonth()+1).toString().padStart(2,'0')}/${dt.getFullYear()}`;
              return `${str} (${d.volRec.toFixed(2)} m³)`;
            });

          // Inserir análise
          document.getElementById('analise').innerHTML = `
            <p><strong>Média diária (período total):</strong> ${avgAll} L</p>
            <p><strong>Média diária até 30/06/2025:</strong> ${avgUntil} L</p>
            <h3>Média semanal (2ª → domingo):</h3>
            <ul>${weekly.map(w=>`<li>${w.period}: ${w.avg} L</li>`).join('')}</ul>
            <h3>Média cada 15 dias:</h3>
            <ul>${half15.map(h=>`<li>${h.period}: ${h.avg} L</li>`).join('')}</ul>
            <p><strong>Datas de recebimento:</strong> ${receipts.join('; ')}</p>
          `;

          // Gráfico 1 – Consumo Diário
          const trace1 = {
            x: data.map(d=> d.date),
            y: data.map(d=> d.consumo),
            mode: 'markers',
            marker: {
              color: data.map(d=> d.flag ? 'var(--primary-green)' : 'var(--primary-blue)'),
              size: 8
            },
            hovertemplate: data.map(d=>
              d.flag
                ? `Recebimento<br>%{x|%d/%m/%Y}`
                : `Consumo: %{y} L<br>%{x|%d/%m/%Y}`
            )
          };
          Plotly.newPlot('chart-consumo', [trace1], {
            margin:{t:40,b:40,l:50,r:20},
            xaxis:{title:'Data'},
            yaxis:{title:'Consumo (L)'}
          }, {responsive:true});

          // Gráfico 2 – Nível do Tanque
          const trace2 = {
            x: data.map(d=> d.date),
            y: data.map(d=> d.estoque),
            mode: 'lines+markers',
            line: { color: 'var(--primary-blue)' },
            marker: {
              color: data.map(d=> d.flag ? 'var(--primary-green)' : 'var(--primary-blue)'),
              size: 6
            },
            hovertemplate: data.map(d=>
              d.flag
                ? `Recebimento: ${d.volRec.toFixed(2)} m³<br>%{x|%d/%m/%Y}`
                : `Consumo: ${d.consumo} L<br>%{x|%d/%m/%Y}`
            )
          };
          Plotly.newPlot('chart-nivel', [trace2], {
            margin:{t:40,b:40,l:50,r:20},
            xaxis:{title:'Data'},
            yaxis:{title:'Estoque (m³)'}
          }, {responsive:true});
        });
    });
  </script>
</body>
</html>
